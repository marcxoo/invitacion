<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lady Whistledown's Dashboard</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --plum: #6A4B5F;
            --gold: #D4AF37;
            --paper: #FDFBF7;
            --ink: #2c2c2c;
            --success: #27ae60;
            --error: #c0392b;
        }

        body {
            background-color: var(--paper);
            background-image:
                radial-gradient(#D4AF37 0.5px, transparent 0.5px),
                radial-gradient(#D4AF37 0.5px, var(--paper) 0.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            font-family: 'Playfair Display', serif;
            color: var(--ink);
            text-align: center;
            padding: 20px 10px;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* HEADER */
        .masthead {
            margin-bottom: 30px;
            border-bottom: 2px solid var(--gold);
            padding-bottom: 10px;
            display: inline-block;
        }

        h1 {
            font-family: 'Great Vibes', cursive;
            font-size: 3.5rem;
            color: var(--plum);
            margin: 0;
            line-height: 1.2;
            text-shadow: 1px 1px 0px rgba(212, 175, 55, 0.3);
        }

        .subtitle {
            text-transform: uppercase;
            letter-spacing: 3px;
            font-size: 0.9rem;
            color: var(--ink);
            margin-top: 5px;
            font-weight: bold;
        }

        /* METRICS GRID */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 800px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border: 1px solid var(--gold);
            border-radius: 4px;
            box-shadow: 4px 4px 0px rgba(106, 75, 95, 0.1);
            transition: transform 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
        }

        .metric-label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-bottom: 10px;
            display: block;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--plum);
            line-height: 1;
        }

        .metric-sub {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }

        /* GUEST LIST TABLE */
        .table-container {
            width: 100%;
            max-width: 800px;
            background: white;
            border: 1px solid var(--gold);
            border-radius: 4px;
            overflow: hidden;
            /* For rounded corners */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .table-header {
            background: var(--plum);
            color: white;
            padding: 15px;
            font-family: 'Great Vibes', cursive;
            font-size: 1.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .guest-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }

        .guest-table th {
            background: #f8f8f8;
            padding: 12px 15px;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #555;
            border-bottom: 1px solid #eee;
        }

        .guest-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .guest-table tr:last-child td {
            border-bottom: none;
        }

        .badge-count {
            background: var(--gold);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 5px;
        }

        .status-yes {
            color: var(--success);
            font-weight: bold;
        }

        .status-no {
            color: var(--error);
            font-weight: bold;
        }

        /* ACTIONS */
        .action-bar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 600px;
        }

        button {
            background: white;
            border: 1px solid var(--plum);
            color: var(--plum);
            padding: 10px 20px;
            font-family: 'Playfair Display', serif;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 4px;
        }

        button:hover {
            background: var(--plum);
            color: white;
        }

        .btn-refresh {
            background: var(--plum);
            color: white;
            border: none;
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>

<body>

    <div class="masthead">
        <h1>Society Papers</h1>
        <div class="subtitle">Reporte Oficial de Asistencia</div>
    </div>

    <!-- METRICS -->
    <div class="metrics-grid">
        <div class="metric-card">
            <span class="metric-label">Inv. Aceptadas</span>
            <div id="m-responses" class="metric-value">0</div>
            <div class="metric-sub">Familias/Grupos</div>
        </div>
        <div class="metric-card" style="border-color: var(--success); background: #fafffb;">
            <span class="metric-label">Total Personas</span>
            <div id="m-people" class="metric-value" style="color: var(--success);">0</div>
            <div class="metric-sub">Asistentes Reales</div>
        </div>
        <div class="metric-card" style="border-color: var(--error);">
            <span class="metric-label">Declinados</span>
            <div id="m-declined" class="metric-value" style="color: var(--error);">0</div>
        </div>
    </div>

    <!-- TABLE -->
    <div class="table-container">
        <div class="table-header">
            <span>Lista de Invitados</span>
            <span style="font-size: 1rem; opacity: 0.8;">XV A√±os</span>
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
            <table class="guest-table">
                <thead>
                    <tr>
                        <th width="50%">Nombre / Familia</th>
                        <th width="20%" style="text-align: center;">Personas</th>
                        <th width="30%" style="text-align: right;">Estado</th>
                    </tr>
                </thead>
                <tbody id="guest-tbody">
                    <tr>
                        <td colspan="3" style="text-align: center; color: #999; padding: 30px;">
                            Cargando datos de la alta sociedad...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="action-bar">
        <button class="btn-refresh" onclick="fetchGuests()">‚ö° Actualizar Tablero</button>
    </div>

    <div class="action-bar" style="border-top: 1px solid #ccc; padding-top: 20px; margin-top: 10px;">
        <button onclick="requestReset()" style="border-color: #999; color: #666; font-size: 0.8rem;">
            ‚ö†Ô∏è Borrar Todo (Reset DB)
        </button>
        <button onclick="resetMyDevice()" style="border-color: #999; color: #666; font-size: 0.8rem;">
            üì± Liberar mi Celular
        </button>
        <button onclick="copyResetLink()" style="border-color: #999; color: #666; font-size: 0.8rem;">
            üîó Copiar Reset Link
        </button>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://bpibrqhnrtkonukktjni.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwaWJycWhucnRrb251a2t0am5pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2OTE0MDIsImV4cCI6MjA4NDI2NzQwMn0.a0D2X-6ZfDULYK-uzmjVySBsEeyQaKCthh5vxeAydK4';

        async function fetchGuests() {
            const tbody = document.getElementById('guest-tbody');
            const mResponses = document.getElementById('m-responses');
            const mPeople = document.getElementById('m-people');
            const mDeclined = document.getElementById('m-declined');

            // Feedback loading
            mPeople.style.opacity = '0.5';

            try {
                // Fetch all data
                const res = await fetch(`${SUPABASE_URL}/rest/v1/rsvp?select=*&order=created_at.desc`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });

                if (!res.ok) throw new Error('Error de conexi√≥n con Supabase');

                const allVotes = await res.json();

                // --- DEDUPLICATION LOGIC ---
                // "Last Vote Wins"
                const uniqueGuests = new Map();
                for (const vote of allVotes) {
                    if (!vote.nombre) continue;
                    const key = vote.nombre.trim().toLowerCase();
                    if (!uniqueGuests.has(key)) {
                        uniqueGuests.set(key, vote); // Keep first found (newest)
                    }
                }
                const guests = Array.from(uniqueGuests.values());

                // --- METRICS ---
                const yesGroups = guests.filter(g => g.asistira);
                const noResponse = guests.filter(g => !g.asistira);

                // Calculate Total People (Sum of 'cantidad' field)
                // Fallback to 1 if 'cantidad' is null (backwards compatibility)
                const totalPax = yesGroups.reduce((acc, g) => acc + (g.cantidad || 1), 0);

                // --- UI UPDATE ---
                mResponses.innerText = yesGroups.length;
                mPeople.innerText = totalPax;
                mDeclined.innerText = noResponse.length;
                mPeople.style.opacity = '1';

                // --- RENDER TABLE ---
                if (guests.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 20px;">A√∫n no hay confirmaciones.</td></tr>';
                    return;
                }

                let html = '';
                for (const g of guests) {
                    const isYes = g.asistira;
                    const pax = (g.cantidad || 1);
                    const date = new Date(g.created_at).toLocaleDateString();

                    html += `
                        <tr style="${!isYes ? 'background: #fff5f5;' : ''}">
                            <td>
                                <strong>${g.nombre}</strong>
                                <div style="font-size: 0.7rem; color: #999;">Registrado: ${date}</div>
                            </td>
                            <td style="text-align: center;">
                                ${isYes ? `<span class="badge-count">${pax}</span>` : '<span style="color:#ccc;">-</span>'}
                            </td>
                            <td style="text-align: right;">
                                ${isYes ? '<span class="status-yes">CONFIRMADO</span>' : '<span class="status-no">DECLIN√ì</span>'}
                            </td>
                        </tr>
                    `;
                }
                tbody.innerHTML = html;

            } catch (e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="3" style="color: red; text-align: center; padding: 20px;">Error al cargar: ${e.message}</td></tr>`;
            }
        }

        async function requestReset() {
            const password = prompt("üîê CLAVE DE SEGURIDAD (Admin):", "");
            if (password !== "luisana15") {
                if (password) alert("‚õî Clave incorrecta");
                return;
            }

            if (!confirm("‚ö†Ô∏è ¬ø‚ö†Ô∏è EST√ÅS SEGURO?\n\nEsto borrar√° PERMANENTEMENTE toda la lista de invitados de la base de datos.\nNo se puede deshacer.")) return;

            try {
                // DELETE via REST 
                await fetch(`${SUPABASE_URL}/rest/v1/rsvp?id=neq.0`, {
                    method: 'DELETE',
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                alert("‚úÖ Base de datos limpiada.");
                fetchGuests();
            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        function resetMyDevice() {
            localStorage.removeItem('voted_luisana_15');
            alert("‚úÖ Dispositivo liberado. Puedes volver a votar.");
        }

        function copyResetLink() {
            const link = "https://invitacion-luisana-gm.vercel.app/?action=reset";
            navigator.clipboard.writeText(link).then(() => alert("üìã Link copiado"));
        }

        // Init
        fetchGuests();
    </script>
</body>

</html>